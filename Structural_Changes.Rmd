---
title: "Ingalls Standards Project: Structural Changes"
author: "R.Lionheart"
date: "Start date: 3/17/2020"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
library(httr) 
library(stringr)
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE)
```

## IMPORTANT: PLEASE READ
The below code blocks represent **the order** in which large structural changes were made. Running these code blocks *WILL NOT* replace or modify any of the Ingalls_Standards sheets. They exist only as a reference for troubleshooting. 

### This markdown document controls the original large structural changes made in 2020, and the revamp completed in the summer of 2021.

#### Change Log
4/8/20: Internal standards updated to reflect consistent naming scheme.  
4/20/20: Abbreviated compounds switched to full-length KEGG names.  
4/20/20: Adjusted compounds with incorrect capitalization.  
4/22/20: Added or removed symbols as required by KEGG names.  
4/23/20: Update last compounds not falling into the above groups.
4/23/20: Complete renaming of compounds, including those that didn't change from the original names.
4/28/20: Adjust vitamins to descriptive names.
4/29/20: Adjust abbreviations for consistency.
5/8/20: FINAL NAMES DECIDED FOR PRIMARY ID.
5/28/20: Bug fixes in final names.
5/28/20: First suggestions for Figure Name column.
6/3/20: Final Figure Names decided.
7/30/20: ChEBI names scraped from website and added in new column.
8/3/20: IUPAC, InCHI, and SMILES columns added to standards.
8/10/20: Classyfire classifications added for those compounds that have them.
10/14/20: First version of SQL-safe names introduced. 
10/22/20: Remove all trailing numbers from SQL-safe names. This is the column to be used for CMAP.

Changing all column names and stuff at the end so this markdown remains as backwards compatible as possible.
Keep the IUPAC/INCHI/SMILES stuff like title and molecular fomula? Check that.
------

#### Primary ID (column: Compound_Name)
```{r Primary ID code, include=TRUE}
source("src/Primary_ID.R")

rm(list=setdiff(ls(), "Ingalls_Lab_Standards_PrimaryID"))
```

#### Shortened names (column: Compound_Name.figure)
```{r Figures Names code, include=TRUE}
source("src/Figure_Names.R")

rm(list=setdiff(ls(), "Ingalls_Lab_Standards_FigNames"))
```

-----

#### SQL-safe names: no special characters or leading numbers.
```{r Source SQL-Safe code, include=TRUE}
source("src/SQL_Safe.R")

rm(list=setdiff(ls(), "Ingalls_Lab_Standards_SQL"))
```

-----

#### KEGG names
This section can take quite a while; if you don't want to run the chunk you can use the latest downloaded
version. Uncomment the code you want to use 
```{r KEGG code, include=TRUE}
## Option 1: Pull down latest data from KEGG (only run if you want the absolute latest version).
## This also includes saving the latest scrape to the data_extra folder.

# path <- "http://rest.kegg.jp/list/compound"
# raw_content <- GET(url = path) %>%
#   content()
# All_KEGG_IDs <- read.csv(text = gsub("\t\n", "", raw_content), sep = "\t",
#               header = FALSE, col.names = c("cmpd", "name"))
# write.csv(All_KEGG_IDs, paste0("data_extra/KEGG_Compounds_",
#                                format(Sys.time(), "%d-%b-%Y"), ".csv"),
#           row.names = FALSE)


## Option 2: load pre-saved KEGG scrape. The date in the filename indicates
## when it was last downloaded. You will need to enter the filename correctly 
## for the My_KEGG_File variable, as there may be many downloaded KEGG files.

My_KEGG_File <- "KEGG_Compounds_28-Jul-2021"
All_KEGG_IDs <- read.csv(dir("data_extra/", full.names=T, pattern=My_KEGG_File))

source("src/KEGG.R")

rm(list=setdiff(ls(), "Ingalls_Lab_Standards_KEGG"))
```

-----

#### ChEBI names
The section below is for updating ChEBI and can take quite a while; if you don't want to update ChEBI you can skip this chunk and use the latest downloaded version (next chunk).
```{r Download latest ChEBI, include=TRUE}
# grabChEBI <- function(compound_id) {
#   # Accepts a KEGG ID (format cpd:C[number]) and returns
#   # the ChEBI id found on the KEGG webpage. If there are multiple, return the
#   # first one. If not found, return NA.
#   if(is.na(compound_id)) {
#     return(NA)
#   }
#   ChEBI <- compound_id %>%
#     paste0("http://rest.kegg.jp/get/", .) %>%
#     GET() %>%
#     content() %>%
#     as.character() %>%
#     strsplit(., "\\n") %>%
#     unlist() %>%
#     grep(pattern = "ChEBI", value = TRUE) %>%
#     trimws(which = "both")
#   ChEBI <- sub("^(\\S*\\s+\\S+).*", "\\1", ChEBI)
#   ChEBI <- gsub( " ", "", ChEBI)
#   if(length(ChEBI) == 0) {
#     return(NA)
#   }
#   return(ChEBI)
# }
# 
# # Reassign the FigNames standards from the Figure_Names.R script
# All_Standards <- Ingalls_Lab_Standards_KEGG
# All_Standards$CHEBI <- gsub("CHEBI", "ChEBI", All_Standards$CHEBI)
# 
# # Apply the ChEBI retrieval function to the standards list
# ChEBI_Names <- sapply(unique(All_Standards$C0), grabChEBI)
# names(ChEBI_Names)[which(is.na(names(ChEBI_Names)))] <- "NA"
# 
# # Compare old and new ChEBI values
# Latest_ChEBI <- data.frame(ChEBI_Names) %>%
#   drop_na() %>%
#   rownames_to_column(var = "C0")
# 
# Full_ChEBI <- All_Standards %>%
#   left_join(Latest_ChEBI)
# 
# # Write the latest download here if you want to save it.
# Last_ChEBI_Download <- data.frame(Full_ChEBI)
# write.csv(Last_ChEBI_Download, paste0("data_extra/ChEBI_Download_",
#                                       format(Sys.time(), "%d-%b-%Y"), ".csv"),
#           row.names = FALSE)
```

This section is for using the last downloaded ChEBI file.
```{r Last updated ChEBI, include=TRUE}
# Load the latest ChEBI scrape if you don't want to run the whole function.
My_ChEBI_File <- "ChEBI_Download_02-Aug-2021"
Full_ChEBI <- read.csv(dir("data_extra/", full.names=T, pattern = My_ChEBI_File))
```

This section runs the downloaded ChEBI data and updates the Ingalls Standards.
```{r Run ChEBI, include=TRUE}
source("src/ChEBI.R")

rm(list=setdiff(ls(), "Ingalls_Lab_Standards_ChEBI"))
```

-----

#### IUPAC, InCHl, SMILES columns
As with KEGG and ChEBI, the section below updates the IUPAC, INCHI, and SMILES columns, and takes a few minutes to run. You can either run the chunk to get the latest data, or use a previously downloaded version.
```{r IUPAC, InCHI, and SMILES code, include=TRUE}

# Standards_Names <- read.csv("Ingalls_Lab_Standards.csv") %>%
#   select(Compound.Name) %>%
#   unique() 
# Standards_Names <- Standards_Names[["Compound.Name"]]
# 
# httr::set_config(httr::config(http_version = 0))
# Looped_Names = list()
# 
# for (i in Standards_Names) {
#   path <- paste("https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/", i, 
#                 "/property/Title,MolecularFormula,inchikey,CanonicalSMILES,IUPACName/CSV", sep = "")
#   print(path)
#   
#   r <- GET(url = path)
#   Sys.sleep(1)
#   status_code(r)
#   content(r)
#   names <- read.csv(text = gsub("\t\n", "", r), sep = ",",
#                      header = TRUE)
#   Looped_Names[[i]] <- names 
# }
# 
# IUPAC_InCHI_SMILES = bind_rows(Looped_Names) %>%
#   rename(Compound.Name = Title) %>%
#   filter(Compound.Name %in% Ingalls_Lab_Standards_ChEBI$Compound.Name) %>%
#   select(CID:IUPACName)
# 
# write.csv(IUPAC_InCHI_SMILES, paste0("data_extra/IUPAC_Download_",
#                                       format(Sys.time(), "%d-%b-%Y"), ".csv"),
#           row.names = FALSE)

```

```{r Last updated PubChem, include=TRUE}
# Load the latest ChEBI scrape if you don't want to run the whole function.
My_IUPAC_File <- "IUPAC_Download_02-Aug-2021"
Full_IUPAC <- read.csv(dir("data_extra/", full.names=T, pattern = My_IUPAC_File))
```

```{r Add all PubChem code, include=TRUE}
source("src/IUPAC_InChl_Smiles.R")

rm(list=setdiff(ls(), "Ingalls_Lab_Standards_AllPubChem"))
```

-----

The next section deals with the ClassyFire ID section. 
The source code for creating the ClassyFire IDs commented out: *DO NOT RUN THE High Class Function LINE UNLESS YOU WOULD LIKE TO COMPLETELY UPDATE IT!* 
The other scrapes take on the order of minutes, this one can take up to several hours. 

#### Classyfire column
```{r Source Classyfire code, include=TRUE}
### source("src/High_Class_Function_062220.R") ###
source("src/Classyfire.R")

rm(list=setdiff(ls(), "Ingalls_Lab_Standards_Classyfire"))
```


----

#### Standards Facelift

```{r Standards Facelift, include=TRUE}

source("Temp_Standards.R")

```

This section handles the layout changes for the standards sheet; including column removal/addition, column order, and 
