---
title: "Ingalls Standards Project"
author: "R.Lionheart"
date: "Start date: 3/17/2020"
output:
  html_document: default
  pdf_document: default
---

### Overview
The most updated version of the Ingalls_Lab_Standards.csv lives in Katherine's github at the following link: 
[Ingalls Lab Standards](https://github.com/kheal/Example_Untargeted_Metabolomics_Workflow)

A new repository has been made for this project: [New Ingalls Lab Standards](https://github.com/IngallsLabUW/Ingalls_Standards)

View the most recent Ingalls Standards in this repository, titled Ingalls_Standards_NEW.csv.

------

#### Proposed short-term changes

*Capitalization*  
* Dimethyl glycine --> Dimethylglycine  
* thiamine pyrophosphate --> Thiamine pyrophosphate, or Vitamin B1  
* 3-Sulfopyruvic Acid --> 3-Sulfopyruvic acid  

*Symbols*  
* B-apo-8'-carotenal  
* Keto-?-(methylthio)butyric acid  
* N(e)-Acetyl-Lysine  
* Trimethylammonium Propionate (TMAP)  
* 3 Indolebutyric Acid and 3 Indolepropionic Acid vs 3-Indoleacetonitrile, 3-Sulfopyruvic Acid, etc.  

*Other changes*  
* RP B12, which exists in addition to plain B12. This should be Cyano b12 or Cyanocobalamin. This is a leftover mistake from replacing cyano to RP for the chromatography.  
* Glutamic acid v Glutamate  
* Betaine v Glycine betaine  
* Check on intra-compound capitalization, eg "1-stearoyl-2-oleoyl-sn-glycero-3-phosphoethanolamine"  


#### Long-term Changes
* Primary name column, how we refer to it in the lab and how it will be ID'd in analysis.
* Include a column for syntactically correct names, which may or may not be the primary name.
* Possibly include a column of annotation, depending on size/how much info is in that column.
* Set up system to keep note of changes to official KEGG compound names whether or not those changes are enacted.

------

# Change Log
4/8/20: Internal standards updated to reflect consistent naming scheme.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("src/Functions.R")

library(stringr)
library(tidyverse)
```

```{r imports, include=FALSE}
# Complete datasets
Kegg.compounds <- read.csv("data_raw/KEGGCompounds_withMasses.csv", stringsAsFactors = F)
Ingalls.compounds <- read.csv("data_raw/Ingalls_Lab_Standards.csv", stringsAsFactors = F)

# All compound names isolated from each dataset
Name <- gsub(";", "", as.character(Kegg.compounds$Name), n)
kegg.names <- data.frame(Name, Kegg.compounds$AllNames) %>%
  arrange(Name) %>%
  mutate_all(as.character)

ingalls.names <- as.data.frame(sort(unique(Ingalls.compounds$Compound.Name))) %>%
  rename(Compound = 1) %>%
  mutate(Compound = as.character(Compound))
```

## Renaming of Internal Standards
```{r Import Internal Standards, include=FALSE}
# Assign matching variable to 
matching.variable = "Ingalls"
filenames <- RemoveCsv(list.files(path = "data_raw", pattern = matching.variable))

for (i in filenames) {
  filepath <- file.path("data_raw", paste(i, ".csv", sep = ""))
  assign(make.names(i), read.csv(filepath, stringsAsFactors = FALSE, fileEncoding = "latin1"))
}
```

```{r Change Internal Standards, include=TRUE}
# View list of all changed Internal Standards.
LauraEditsIS <- Ingalls_Lab_Standards_LauraEdit %>%
  select(Compound.Type,Compound.Name_new, Compound.Name_old) %>%
  filter(Compound.Type == "Internal Standard") %>%
  filter(!Compound.Name_new == Compound.Name_old) # Remove compounds that don't change

knitr::kable(LauraEditsIS, caption="Changed Internal Standards", floating.environment="sidewaystable")
```

```{r Incorporate IS changes, include=TRUE}
Ingalls_Lab_Standards_IS <- Ingalls_Lab_Standards %>%
  left_join(LauraEditsIS %>% rename(Compound.Name = Compound.Name_old)) %>%
  mutate(Compound.Name = ifelse(is.na(Compound.Name_new), Compound.Name, Compound.Name_new)) %>%
  select(-Compound.Name_new)

write.csv(Ingalls_Lab_Standards_IS, "Ingalls_Lab_Standards_NEW.csv")
```

------

### Experimental Code + Analysis begins here
Everything below this point may or may not work, and does not reflect any changes that have or will be made to the Ingalls_Lab_Standards.csv.

##### Compounds that are an exact match between KEGG compounds primary name and Ingalls Standards compounds.
```{r matched names, include = TRUE}
my.indices <- which(ingalls.names$Compound %in% kegg.names$Name, useNames = TRUE)
exact.match <- as.data.frame(ingalls.names$Compound[my.indices]) %>%
  rename(Matched = 1) %>%
  mutate_all(as.character)

knitr::kable(exact.match, caption="Current KEGG/Ingalls matched compounds", floating.environment="sidewaystable")
```

##### Compounds with and without current KEGGNAME matches in the existing Ingalls standards csv.
```{r imported ingalls matched, include = TRUE}
no.match <- Ingalls.compounds %>%
  select(Compound.Name, KEGGNAME)
no.match <- no.match[is.na(no.match$KEGGNAME),]

yes.match <- Ingalls.compounds %>%
  select(Compound.Name, KEGGNAME)
yes.match <- yes.match[!is.na(yes.match$KEGGNAME),]
yes.match <- yes.match %>% arrange(Compound.Name)

knitr::kable(yes.match, caption="Existing KEGG pairs, NOT MATCHES", floating.environment="sidewaystable")
knitr::kable(no.match, caption="Ingalls compounds, no existing match", floating.environment="sidewaystable")

```

------

##### Compounds that are duplicated within the Ingalls_Lab_Standards csv, for HILIC ion mode or multiple run type detection.
```{r duplicates, include=TRUE}
ingalls.duplicated <- Ingalls.compounds %>%
  select(Compound.Name, Column, z, Fraction1, Fraction2, KEGGNAME) %>%
  group_by(Category = stringi::stri_trans_totitle(Compound.Name)) %>% # ignores capitalization
  filter(n() > 1) %>%
  arrange(Compound.Name)

knitr::kable(ingalls.duplicated, caption="Duplicated Ingalls Compounds", floating.environment="sidewaystable")
```

------

##### All current internal standards used in the Ingalls lab. 
```{r internal standards, include=TRUE}
internal.standards <- Ingalls.compounds %>%
  filter(Compound.Type == "Internal Standard")

knitr::kable(internal.standards[, 2:3], caption="Existing Ingalls internal standards", floating.environment="sidewaystable")
```


### Experimental Code and Analysis: Everything below this point is just exploratory.


#### All Ingalls standards capitalized. 
This doesn't account for those compounds that don't need to be capitalized, such as p-Coumaric acid, which now shows up as P-Coumaric Acid. This will be edited to reflect the KEGG compound primary name.
```{r experimental, include=FALSE}
CapitalizeWords <- function(x) {
  s <- strsplit(x, " ")[[1]]
   paste(toupper(substring(s, 1, 1)), substring(s, 2),
       sep="", collapse=" ")
}
```

```{r Rename Internal Standards, include=TRUE}
# View list of all changed Internal Standards.
LauraEditsIS <- Ingalls_Lab_Standards_LauraEdit %>%
  select(Compound.Type,Compound.Name_new, Compound.Name_old) %>%
  filter(Compound.Type == "Internal Standard") %>%
  filter(!Compound.Name_new == Compound.Name_old) # Remove compounds that don't change

knitr::kable(LauraEditsIS[c(2:3)],
            caption="Renamed Ingalls Standards", floating.environment="sidewaystable")
```

```{r Incorporate IS changes, include=TRUE}
Ingalls_Lab_Standards_IS <- Ingalls_Lab_Standards %>%
  left_join(LauraEditsIS %>% rename(Compound.Name = Compound.Name_old)) %>%
  mutate(Compound.Name = ifelse(is.na(Compound.Name_new), Compound.Name, Compound.Name_new))

write.csv(Ingalls_Lab_Standards_IS, "Ingalls_Lab_Standards_NEW.csv")

```

##### Compounds that are an exact match between KEGG compounds and Ingalls Standards compounds.
```{r matched names, include = TRUE}
matched <- Kegg.compounds %>% filter(Name %in% ingalls.names)
knitr::kable(matched[, 4:6],caption="Current KEGG/Ingalls matched compounds", floating.environment="sidewaystable")
```

##### Compounds that are duplicated within the Ingalls_Lab_Standards csv, for HILIC ion mode or multiple run type detection.
```{r duplicates, include=TRUE}
duplicated.ingalls <- Ingalls.compounds %>%
  group_by(Category = stringi::stri_trans_totitle(Compound.Name)) %>%
  filter(n() > 1) %>%
  arrange(Compound.Name)

knitr::kable(duplicated.ingalls[c(2:3, 10, 16:17, 19, 22)],
             caption="Duplicated Ingalls Compounds", floating.environment="sidewaystable")
```

#### All Ingalls standards capitalized.
This doesn't account for those compounds that don't need to be capitalized, such as p-Coumaric acid, which now shows up as P-Coumaric Acid. This will be edited to reflect the KEGG compound primary name.
```{r experimental, include=FALSE}
CapitalizeWords <- function(x) {
  s <- strsplit(x, " ")[[1]]
   paste(toupper(substring(s, 1, 1)), substring(s, 2),
       sep="", collapse=" ")
}

cmpds.capitalized <- as.data.frame(sapply(ingalls.names, CapitalizeWords)) %>% rownames_to_column()
colnames(cmpds.capitalized) <- c("Original", "Capitalized")
cmpds.changed <- cmpds.capitalized[, 1:2] %>%
  mutate(Change = rowSums(cmpds.capitalized == cmpds.capitalized[, 1]) == ncol(cmpds.capitalized)) %>%
  filter(Change == FALSE) %>%
  select(-Change)
```

```{r capitalize, include=TRUE}
knitr::kable(cmpds.changed,
             caption="All Compounds Capitalized", floating.environment="sidewaystable")
```

Check for improper changes against the KEGG compounds. This returns row locations of all matches. Will require some work to filter compounds correctly.
```{r KEGG check, include=TRUE}

ethanol.example <- sapply(colnames(kegg.names[]),
                          function(x) grep("ethanol", kegg.names[, x], ignore.case = TRUE))

ethanol.example

```
