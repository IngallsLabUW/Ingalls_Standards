---
title: "Ingalls Standards Project"
author: "R.Lionheart"
date: "Start date: 3/17/2020"
output:
  html_document: default
  pdf_document: default
---

### Overview
The most updated version of the Ingalls_Lab_Standards.csv lives in Katherine's github at the following link: 
[Ingalls Lab Standards](https://github.com/kheal/Example_Untargeted_Metabolomics_Workflow)

A new repository has been made for this project: [New Ingalls Lab Standards](https://github.com/IngallsLabUW/Ingalls_Standards)

View the most recent Ingalls Standards in this repository, titled Ingalls_Standards_NEW.csv.

------

#### Changes made in v1.0

*Capitalization*  
* All "Acid"s changed to "acid", as per KEGG conventions. Example: 3-Sulfopyruvic Acid --> 3-Sulfopyruvic acid   
* First appearance of compound in complete name capitalized. Example: 7-dehydrocholesterol --> 7-Dehydrocholesterol, thiamine pyrophosphate --> Thiamine pyrophosphate  
* "B-compoundName" changed to beta-CompoundName. Example: B-ionine --> beta_Ionine  
* Second part of compound name lowercase. Example: Glutathione Disulfide --> Glutathione disulfide  

*Abbreviations*  
To alleviate long commpound names, the primary ID will remain as the KEGG name or reasonable abbreviation but a more manageable name will go under the "Figure Names" column. 

*Symbols*  
All symbols that are part of the KEGG name will remain in place. A syntactically correct column will be added for upload to CMAP, etc.

*Other specific changes*  
* RP B12 --> Cyanocobalamin  
* All B12s --> Methylcobalamin, Hydroxocobalamin, etc.  
* Betaine --> Glycine betaine  
* Dimethyl glycine --> Dimethylglycine  
* All Vitamins changed to their descriptive name: Vitamine B1 --> Thiamine, Vitamin B2 --> Riboflavin, etc.  


#### Long-term Changes
* Add in a Figure Name column.  
* Include a column for syntactically correct names, which may or may not be the primary name.
* Possibly include a column of annotation, depending on size/how much info is in that column.
* Set up system to keep note of changes to official KEGG compound names whether or not those changes are enacted.  
* Add stereoisomer orientation column.  
* List of all commonly used names for a compound (eg Glutamic acid == Glutamate).  

------

## Change Log
4/8/20: Internal standards updated to reflect consistent naming scheme.  
4/20/20: Abbreviated compounds switched to full-length KEGG names.  
4/20/20: Adjusted compounds with incorrect capitalization.  
4/22/20: Added or removed symbols as required by KEGG names.  
4/23/20: Update last compounds not falling into the above groups.
4/23/20: Complete renaming of compounds, including those that didn't change from the original names.
4/28/20: Adjust vitmins to descriptive names.
4/29/20: Adjust abbreviations for consistency.
5/8/20: FINAL NAMES DECIDED FOR PRIMARY ID.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("src/Functions.R")

library(stringr)
library(tidyverse)
```

------

## Renaming of Internal Standards
```{r Import Internal Standards, include=FALSE}
# Assign matching variable to 
matching.variable = "Ingalls"
filenames <- RemoveCsv(list.files(path = "data_raw", pattern = matching.variable))

for (i in filenames) {
  filepath <- file.path("data_raw", paste(i, ".csv", sep = ""))
  assign(make.names(i), read.csv(filepath, stringsAsFactors = FALSE, fileEncoding = "latin1"))
}
```

```{r Change Internal Standards, include=TRUE}
# View list of all changed Internal Standards.
Ingalls_Lab_Standards_LauraEdit[Ingalls_Lab_Standards_LauraEdit == "O-Propanoylcarnitine"] <- "O-Propionylcarnitine"
Ingalls_Lab_Standards_LauraEdit[Ingalls_Lab_Standards_LauraEdit == "O-Acetyl-L-carnitine"] <- "O-Acetylcarnitine"

LauraEditsIS <- Ingalls_Lab_Standards_LauraEdit %>%
  select(Compound.Type,Compound.Name_new, Compound.Name_old) %>%
  filter(Compound.Type == "Internal Standard") %>%
  filter(!Compound.Name_new == Compound.Name_old) # Remove compounds that don't change

knitr::kable(LauraEditsIS[1:10, ], caption="Changed Internal Standards", floating.environment="sidewaystable")
```

```{r Incorporate IS changes, include=TRUE}
Ingalls_Lab_Standards_IS <- Ingalls_Lab_Standards %>%
  left_join(Ingalls_Lab_Standards_LauraEdit %>% rename(Compound.Name = Compound.Name_old)) %>%
  rename(Compound.Name_old = Compound.Name,
         Compound.Name = Compound.Name_new) %>%
  select(Compound.Type, Column, Compound.Name, Compound.Name_old, everything()) %>%
  mutate(Compound.Name_old = ifelse(Compound.Type == "Internal Standard" & Compound.Name == Compound.Name_old, 
                                    Compound.Name, Compound.Name_old)) %>%
  mutate(Compound.Name = ifelse(Compound.Type == "Internal Standard", Compound.Name, NA))

write.csv(Ingalls_Lab_Standards_IS, "Ingalls_Lab_Standards_NEW.csv")
```

-----

## Abbreviations
```{r Next experimental Laura, include=FALSE}
Abbreviations <- Ingalls_Lab_Standards_LauraEdit %>%
  left_join(Ingalls_Lab_Standards_AlecEdit %>% rename(Compound.Name_Alec = Compound.Name)) %>%
  select(Compound.Name_new, Compound.Name_Alec, Compound.Name_old, Compound.Type) %>%
  mutate(Compound.Name_new = recode(Compound.Name_new,
                                    "DMSP" = "Dimethylsulfoniopropionate",
                                    "ADP" = "Adenosine diphosphate",
                                    "AMP" = "Adenosine monophosphate",
                                    "ATP" = "Adenosine triphosphate",
                                    "FAD" = "Flavin adenine dinucleotide",
                                    "GMP" = "Guanosine monophosphate",
                                    "GMP, 15N5" = "Guanosine monophosphate, 15N5",
                                    "GTP" = "Guanosine triphosphate",
                                    "PEP" = "Phosphoenolpyruvic acid")) %>%
  filter(Compound.Type != "Internal Standard",
         Compound.Name_new != Compound.Name_old | Compound.Name_old != Compound.Name_Alec) %>% # Filters out the 30HC12-HSL
  mutate(letter.count = nchar(Compound.Name_old)) %>%
  arrange(letter.count) %>%
  filter(nchar(Compound.Name_old) < 10 | Compound.Name_old == "(3-Carboxypropyl)trimethylammonium (TMAB)",
         nchar(Compound.Name_old) < 7 | str_detect(Compound.Name_old, "-")) %>%
  mutate(Compound.Name_new = recode(Compound.Name_new,
                                    "TMAB" = "(3-Carboxypropyl)trimethylammonium",
                                    "cAMP" = "3',5'-Cyclic AMP",
                                    "cGMP" = "3',5'-Cyclic GMP",
                                    "Cys-Gly" = "L-Cysteinylglycine")) 
```

### Show list of abbreviated compounds to be changed
```{r View abbreviation table, include=TRUE}
knitr::kable(Abbreviations, caption="Potential Abbreviation Changes", floating.environment="sidewaystable")
```

### Finalize changes of abbreviated compounds
```{r Change abbreviated compounds, include=TRUE}
Ingalls_Lab_Standards_Abbr <- Ingalls_Lab_Standards_IS %>%
  left_join(Abbreviations %>% select(Compound.Name_new, Compound.Name_old) %>% unique()) %>%
  select(Compound.Name, Compound.Name_new, Compound.Name_old, Compound.Type, everything()) %>%
  mutate(Compound.Name = ifelse(is.na(Compound.Name), Compound.Name_new, Compound.Name)) %>%
  select(Compound.Type, Column, everything(), -Compound.Name_new) 

write.csv(Ingalls_Lab_Standards_IS, "Ingalls_Lab_Standards_NEW.csv")
```

-----

### Isolate different capitalizations of compounds
```{r Capitalizations, include=FALSE}
Capitalizations <- Ingalls_Lab_Standards_LauraEdit %>%
  left_join(Ingalls_Lab_Standards_AlecEdit %>% rename(Compound.Name_Alec = Compound.Name)) %>%
  select(Compound.Name_new, Compound.Name_Alec, Compound.Name_old, Compound.Type) %>%
  filter(!Compound.Name_new %in% Ingalls_Lab_Standards_Abbr$Compound.Name, # drop commpounds already reassigned
          Compound.Name_new != Compound.Name_old | Compound.Name_old != Compound.Name_Alec) # drop compounds that don't require renaming
```

```{r View Capitalizations, include=TRUE}
Acid.Capitals <- Capitalizations %>%
  filter(str_detect(Compound.Name_new, regex("acid", ignore_case = TRUE))) %>%
  select(Compound.Name_new, Compound.Name_old)
Beta.Capitals <- Capitalizations %>%
  filter(str_detect(Compound.Name_new, regex("beta-", ignore_case = TRUE))) %>%
  select(Compound.Name_new, Compound.Name_old)
Just.Capitals <- Capitalizations %>%
  select(Compound.Name_new, Compound.Name_old) %>%
  filter(!Compound.Name_new %in% c(Acid.Capitals$Compound.Name_new, Beta.Capitals$Compound.Name_new),
         tolower(Compound.Name_new) == tolower(Compound.Name_old),
         Compound.Name_new != Compound.Name_old) %>%
  unique()

```

### View "Acids", "Beta", and different-capitalization compounds.
```{r View capitalization tables, include=TRUE}
knitr::kable(Acid.Capitals[1:10, ], caption="First 10 Capitalized 'Acid' Compounds", floating.environment="sidewaystable")
knitr::kable(Beta.Capitals, caption="Transition from 'B-' to 'beta-", floating.environment="sidewaystable")
knitr::kable(Just.Capitals[1:10, ], caption="First 10 Compounds Non-case Matching", floating.environment="sidewaystable")

Complete.Caps <- Acid.Capitals %>%
  rbind(Beta.Capitals) %>%
  rbind(Just.Capitals)
```

### Finalize changes of abbreviated compounds
```{r Change capitalized compounds, include=TRUE}
Ingalls_Lab_Standards_Caps <- Ingalls_Lab_Standards_Abbr %>%
  left_join(Complete.Caps) %>%
  select(Compound.Name, Compound.Name_new, Compound.Name_old, Compound.Type, everything()) %>%
  mutate(Compound.Name = ifelse(is.na(Compound.Name), Compound.Name_new, Compound.Name)) %>%
  select(Compound.Type, Column, everything(), -Compound.Name_new) %>%
  unique()

write.csv(Ingalls_Lab_Standards_Caps, "Ingalls_Lab_Standards_NEW.csv")
```

-----

```{r Symbols, include=FALSE}
Symbols <- Ingalls_Lab_Standards_Caps %>%
  left_join(Ingalls_Lab_Standards_AlecEdit %>% rename(Compound.Name_Alec = Compound.Name)) %>%
  left_join(Ingalls_Lab_Standards_LauraEdit) %>%
  select(Compound.Name, Compound.Name_new, Compound.Name_Alec, Compound.Name_old, Compound.Type) %>%
  filter(is.na(Compound.Name)) %>%
  filter(Compound.Name_new != Compound.Name_old | Compound.Name_old != Compound.Name_Alec) %>%
  select(Compound.Name_new, Compound.Name_old) %>%
  filter_all(any_vars(str_detect(., "[^[:alnum:] ]"))) %>%
  unique()

```

### View Symbols that will be changed
```{r View symbols table, include=TRUE}
knitr::kable(Symbols[1:10, ], caption="First 10 Symbol Changes", floating.environment="sidewaystable")
```

### Finalize changes of compounds with symbols
```{r Change compounds with symbols, include=TRUE}
Ingalls_Lab_Standards_Symbols <- Ingalls_Lab_Standards_Caps %>%
  left_join(Symbols) %>%
  select(Compound.Name, Compound.Name_new, Compound.Name_old, Compound.Type, everything()) %>%
  mutate(Compound.Name = ifelse(is.na(Compound.Name), Compound.Name_new, Compound.Name)) %>%
  select(Compound.Type, Column, everything(), -Compound.Name_new) %>%
  unique()

write.csv(Ingalls_Lab_Standards_Symbols, "Ingalls_Lab_Standards_NEW.csv")
```

------

### All other compounds not yet changed
```{r Currently unchanged compounds, include=FALSE}
Unchanged <- Ingalls_Lab_Standards_Symbols %>%
  left_join(Ingalls_Lab_Standards_LauraEdit) %>%
  select(Compound.Name, Compound.Name_new, Compound.Name_old) %>%
  filter(is.na(Compound.Name)) %>%
  filter(Compound.Name_new != Compound.Name_old) 

```

```{r View last set of standard names, include=TRUE}
knitr::kable(Unchanged, caption="Last Unchanged Compounds", floating.environment="sidewaystable")
```


### Add changes of still-unedited compounds - Including those that remain as the original name.
```{r Add unchanged compounds, include=TRUE}
Ingalls_Lab_Standards_Extras <- Ingalls_Lab_Standards_Symbols %>%
  left_join(Unchanged) %>%
  select(Compound.Name, Compound.Name_new, Compound.Name_old, Compound.Type, everything()) %>%
  mutate(Compound.Name = ifelse(is.na(Compound.Name), Compound.Name_new, Compound.Name)) %>%
  mutate(Compound.Name = ifelse(is.na(Compound.Name), Compound.Name_old, Compound.Name)) %>%
  select(Compound.Type, Column, everything(), -Compound.Name_new) %>%
  unique()

write.csv(Ingalls_Lab_Standards_Extras, "Ingalls_Lab_Standards_NEW.csv")
```

### Adjust Vitamins to descriptive names
```{r Vitamins, include=FALSE}
Ingalls_Lab_Standards_Vitamins <- Ingalls_Lab_Standards_Extras %>%
  mutate(Compound.Name = recode(Compound.Name, 
          "Vitamin B2, 13C4, 15N2" = "Riboflavin-dioxopyrimidine, 13C4, 15N2",
         	"Vitamin B2" = "Riboflavin",
          "Vitamin C" = "Ascorbic acid",
          "Vitamin D2" = "Calciferol",
          "Vitamin K1" = "Phytonadione",
          "Vitamin K2" = "Menaquinone",
          "AMP, 15N5" = "Adenosine monophosphate, 15N5",
          "Methyl (indol-3-yl)acetate" = "Indole-3-methyl acetate")) %>%
  mutate(Compound.Name = ifelse(Compound.Name_old == "Methyl indole 3 carboxylate", "Methyl indole-3-carboxylate", Compound.Name))

write.csv(Ingalls_Lab_Standards_Vitamins, "Ingalls_Lab_Standards_NEW.csv")

```

------

### Experimental Code + Analysis begins here
Everything below this point may or may not work, and does not reflect any changes that have or will be made to the Ingalls_Lab_Standards.csv.

### Drop stereoisomer designations

```{r Drop stereoisomers, include=TRUE}
Stereoisomers <- Ingalls_Lab_Standards_Vitamins %>%
  filter(str_detect(Compound.Name, "D-|L-|N-|N6-|O-|S-|N6,N6,N6-Trimethyl-L-lysine")) %>%
  filter(!Compound.Name %in% c("2-O-alpha-D-Glucosylglycerol", "UDP-N-acetylglucosamine",
  "Decarboxylated S-Adenosylmethionine", "Trimethylamine N-oxide")) %>%
  filter(!str_detect(Compound.Name, "DL")) %>%
  select(Compound.Type:Compound.Name_old)

knitr::kable(Stereoisomers, caption="Potential Stereoisomer Changes", floating.environment="sidewaystable")
```
2-O-alpha-D-Glucosylglycerol
Decarboxylated S-Adenosylmethionine


### Drop Stereoisomer designations
```{r Stereoisomers, include=FALSE}
Ingalls_Lab_Standards_Stereoisomers <- Ingalls_Lab_Standards_Vitamins %>%
  mutate(Compound.Name = ifelse(Compound.Name %in% Stereoisomers$Compound.Name,
                                "yes", Compound.Name)) %>%
  sort(Compound.Name)
#sub("\\S+\\s+", "", tweetsdf$usertweet)


#write.csv(Ingalls_Lab_Standards_Stereoisomers, "Ingalls_Lab_Standards_NEW.csv")

```


```{r TEST SECTION, include=FALSE}
test <- Ingalls_Lab_Standards_LauraEdit %>%
  left_join(Ingalls_Lab_Standards_AlecEdit %>% rename(Compound.Name_Alec = Compound.Name)) %>%
  select(Compound.Type, Compound.Name_new, Compound.Name_Alec, Compound.Name_old) %>%
  filter(Compound.Name_new == Compound.Name_old | Compound.Name_old == Compound.Name_Alec) %>%
  
  filter(tolower(Compound.Name_new) == tolower(Compound.Name_old),
         Compound.Name_new != Compound.Name_old) 

```

```{r imports, include=FALSE}
# Complete datasets
Kegg.complete <- read.csv("data_raw/KEGGCompounds_withMasses.csv", stringsAsFactors = F)
Ingalls.complete <- read.csv("data_raw/Ingalls_Lab_Standards.csv", stringsAsFactors = F)

# All compound names isolated from each dataset
Name <- gsub(";", "", as.character(Kegg.complete$Name), n)
kegg.names <- data.frame(Name, Kegg.complete$AllNames) %>%
  arrange(Name) %>%
  mutate_all(as.character)

ingalls.names <- as.data.frame(sort(unique(Ingalls.complete$Compound.Name))) %>%
  rename(Compound = 1) %>%
  mutate(Compound = as.character(Compound))
```

##### Compounds that are an exact match between KEGG compounds primary name and Ingalls Standards compounds.
```{r matched names, include = FALSE}
my.indices <- which(ingalls.names$Compound %in% kegg.names$Name, useNames = TRUE)
exact.match <- as.data.frame(ingalls.names$Compound[my.indices]) %>%
  rename(Matched = 1) %>%
  mutate_all(as.character)

knitr::kable(exact.match, caption="Current KEGG/Ingalls matched compounds", floating.environment="sidewaystable")
```

##### Compounds with and without current KEGGNAME matches in the existing Ingalls standards csv.
```{r imported ingalls matched, include = FALSE}
no.match <- Ingalls.complete %>%
  select(Compound.Name, KEGGNAME)
no.match <- no.match[is.na(no.match$KEGGNAME),]

yes.match <- Ingalls.complete %>%
  select(Compound.Name, KEGGNAME)
yes.match <- yes.match[!is.na(yes.match$KEGGNAME),]
yes.match <- yes.match %>% arrange(Compound.Name)

knitr::kable(yes.match, caption="Existing KEGG pairs, NOT MATCHES", floating.environment="sidewaystable")
knitr::kable(no.match, caption="Ingalls compounds, no existing match", floating.environment="sidewaystable")

```

------

##### Compounds that are duplicated within the Ingalls_Lab_Standards csv, for HILIC ion mode or multiple run type detection.
```{r duplicates, include=FALSE}
ingalls.duplicated <- Ingalls.complete %>%
  select(Compound.Name, Column, z, Fraction1, Fraction2, KEGGNAME) %>%
  group_by(Category = stringi::stri_trans_totitle(Compound.Name)) %>% # ignores capitalization
  filter(n() > 1) %>%
  arrange(Compound.Name)

knitr::kable(ingalls.duplicated, caption="Duplicated Ingalls Compounds", floating.environment="sidewaystable")
```

------

#### All Ingalls standards capitalized.
This doesn't account for those compounds that don't need to be capitalized, such as p-Coumaric acid, which now shows up as P-Coumaric Acid. This will be edited to reflect the KEGG compound primary name.
```{r experimental, include=FALSE}
CapitalizeWords <- function(x) {
  s <- strsplit(x, " ")[[1]]
   paste(toupper(substring(s, 1, 1)), substring(s, 2),
       sep="", collapse=" ")
}

cmpds.capitalized <- as.data.frame(sapply(ingalls.names, CapitalizeWords)) %>% rownames_to_column()
colnames(cmpds.capitalized) <- c("Original", "Capitalized")
cmpds.changed <- cmpds.capitalized[, 1:2] %>%
  mutate(Change = rowSums(cmpds.capitalized == cmpds.capitalized[, 1]) == ncol(cmpds.capitalized)) %>%
  filter(Change == FALSE) %>%
  select(-Change)
```

